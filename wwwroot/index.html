<!DOCTYPE html>
<html>
  <head>
    <title>StormSafe</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map = L.map("map").setView([30.604678, -87.110837], 8);
      var nexradLayer = null;
      var currentStation = "KMOB";

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      function updateNEXRADLayer() {
        if (nexradLayer) {
          map.removeLayer(nexradLayer);
        }

        var station = currentStation || "KMOB";
        console.log("Using nearest radar station:", station);

        // Create an image overlay for the radar
        var radarUrl = "/api/weather/radar/" + station + "/N0R?t=" + Date.now();
        console.log("Fetching radar image from:", radarUrl);

        // Create a temporary image to load the radar
        var img = new Image();
        img.onload = function () {
          // Calculate the bounds based on the station's location
          var bounds = [
            [30.0, -88.0],
            [31.0, -86.0],
          ]; // Example bounds for KMOB
          nexradLayer = L.imageOverlay(radarUrl, bounds, {
            opacity: 0.8,
            attribution: "NOAA/NWS",
          });
          nexradLayer.addTo(map);
        };

        img.onerror = function (e) {
          console.error("Error loading radar image:", radarUrl);
          console.error("Error details:", e);

          // Retry up to 3 times with increasing delays
          var retryCount = img.retryCount || 0;
          if (retryCount < 3) {
            console.log(
              "Retrying in 5 seconds... (Attempt " + (retryCount + 1) + "/3)"
            );
            setTimeout(function () {
              img.retryCount = retryCount + 1;
              img.src = radarUrl + "&retry=" + retryCount;
            }, 5000);
          } else {
            console.log("Trying fallback station: KTLH");
            currentStation = "KTLH";
            updateNEXRADLayer();
          }
        };

        img.src = radarUrl;
      }

      // Update the radar layer every 5 minutes
      setInterval(updateNEXRADLayer, 5 * 60 * 1000);

      // Initial load
      updateNEXRADLayer();

      // Function to update storm data
      async function updateStormData() {
        try {
          const center = map.getCenter();
          const response = await fetch(
            `/api/weather/storm-data?latitude=${center.lat}&longitude=${center.lng}`
          );

          if (!response.ok) {
            throw new Error("Network response was not ok");
          }

          const data = await response.json();
          console.log("Storm data:", data);

          // Update UI with storm data here
        } catch (error) {
          console.error("Error fetching storm data:", error);
        }
      }

      // Update storm data when map moves
      map.on("moveend", updateStormData);

      // Initial storm data load
      updateStormData();
    </script>
  </body>
</html>
